<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unscheduled Jobs - Impressive Batteries</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.3rem;
        }

        #map {
            flex: 1;
            width: 100%;
        }

        .info-window {
            max-width: 300px;
            font-size: 14px;
        }

        .info-window h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .info-window .field {
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .info-window .field:last-child {
            border-bottom: none;
        }

        .info-window .label {
            font-weight: 600;
            color: #555;
            margin-right: 5px;
        }

        .info-window .value {
            color: #333;
        }

        .hubspot-button {
            display: inline-block;
            margin-top: 12px;
            padding: 10px 16px;
            background: #ff7a59;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 600;
            font-size: 13px;
            text-align: center;
            transition: background 0.2s;
        }

        .hubspot-button:hover {
            background: #ff5c39;
        }

        .hubspot-button:before {
            content: 'üîó ';
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem 3rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            text-align: center;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats {
            background: white;
            padding: 0.8rem 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .stats-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stats-number {
            font-weight: 700;
            color: #667eea;
            font-size: 1.2rem;
        }

        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            max-width: 500px;
            text-align: center;
        }

        .error-message.hidden {
            display: none;
        }

        .error-message h3 {
            color: #e74c3c;
            margin-bottom: 1rem;
        }

        .error-message code {
            display: block;
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            text-align: left;
            font-size: 0.85rem;
            overflow-x: auto;
        }

        .map-legend {
            background: white;
            padding: 15px;
            margin: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
        }

        .map-legend h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            cursor: pointer;
        }

        .filter-checkbox {
            margin-right: 8px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #666;
        }

        .legend-icon.blue {
            background-color: #2196F3;
        }

        .legend-icon.orange {
            background-color: #FF9800;
        }

        .legend-icon.yellow {
            background-color: #FFEB3B;
        }

        .legend-icon.green {
            background-color: #4CAF50;
        }

        .legend-icon.red {
            background-color: #F44336;
        }

        .legend-icon.purple {
            background-color: #9C27B0;
        }
    </style>
</head>
<body>
    <header>
        <h1>üîã Unscheduled Jobs - Impressive Batteries</h1>
        <div class="subtitle">Installation Locations Map</div>
    </header>

    <div class="stats" id="stats">
        <div class="stats-item">
            <span>Total Jobs:</span>
            <span class="stats-number" id="totalJobs">0</span>
        </div>
        <div class="stats-item">
            <span>Loaded:</span>
            <span class="stats-number" id="loadedJobs">0</span>
        </div>
    </div>

    <div id="map"></div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Loading job locations...</div>
    </div>

    <div class="error-message hidden" id="error">
        <h3>‚ö†Ô∏è Configuration Needed</h3>
        <p id="errorText"></p>
    </div>

    <script>
        // ========================================
        // CONFIGURATION - REPLACE THESE VALUES
        // ========================================
        
        const CONFIG = {
            // Get this from: https://console.cloud.google.com/
            GOOGLE_MAPS_API_KEY: 'AIzaSyD0p3J2nqCRJNJg7pWDHjqfbR2JUfyVnto',
            
            // Your Google Sheets ID from the URL
            // Example: https://docs.google.com/spreadsheets/d/SPREADSHEET_ID_HERE/edit
            GOOGLE_SHEETS_ID: '1qDcE1j41nkvyP1TWEa3T_E_A1ZXzFWeVJH8bNaHi390',
            
            // The name of your sheet/tab (default is usually "Sheet1")
            SHEET_NAME: 'Sheet1',
            
            // Column mapping - adjust these to match your spreadsheet columns
            // Use 0 for column A, 1 for column B, 2 for column C, etc.
            COLUMNS: {
                recordId: 0,          // Column A - Record ID
                customerName: 1,      // Column B - Customer Name
                projectAddress: 2,    // Column C - Project Address
                latitude: 3,          // Column D - Latitude
                longitude: 4,         // Column E - Longitude
                systemSize: 5,        // Column F - System Size [kW]
                batterySize: 6,       // Column G - Battery Size [kWh]
                phases: 7,            // Column H - Phases
                batteryLocation: 8,   // Column I - Battery Location
                installationDate: 9,  // Column J - Installation date
                systemType: 11,       // Column L - System Type (Solar Only, Battery Only, Solar + Battery)
                inverterModel: 12,    // Column M - Inverter Model (ESYSUNHOME HM10/15/20)
                siteInspection: 13    // Column N - Site Inspection Needed (YES/NO)
            },
            
            // Default map center (will auto-adjust to show all markers)
            DEFAULT_CENTER: { lat: -33.8688, lng: 151.2093 }, // Sydney, Australia
            DEFAULT_ZOOM: 10
        };

        // ========================================
        // APPLICATION CODE
        // ========================================

        let map;
        let markers = [];
        let markersByType = {
            'blue': [],
            'orange': [],
            'yellow': [],
            'green': [],
            'red': [],
            'purple': []
        };
        let systemTypeCounts = {
            'blue': 0,
            'orange': 0,
            'yellow': 0,
            'green': 0,
            'red': 0,
            'purple': 0
        };
        let infoWindow;
        let legendElement;

        // Initialize the map
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: CONFIG.DEFAULT_ZOOM,
                center: CONFIG.DEFAULT_CENTER,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });

            infoWindow = new google.maps.InfoWindow();

            // Close info window when clicking on the map
            map.addListener('click', () => {
                infoWindow.close();
            });

            // Add legend to map
            legendElement = document.createElement('div');
            legendElement.className = 'map-legend';
            legendElement.innerHTML = `
                <h3>System Types</h3>
                <div class="legend-item">
                    <input type="checkbox" id="filter-blue" class="filter-checkbox">
                    <div class="legend-icon blue"></div>
                    <span>üìÖ Scheduled Jobs <span id="count-blue">(0)</span></span>
                </div>
                <div class="legend-item">
                    <input type="checkbox" id="filter-orange" class="filter-checkbox" checked>
                    <div class="legend-icon orange"></div>
                    <span>‚ö†Ô∏è Site Inspection <span id="count-orange">(0)</span></span>
                </div>
                <div class="legend-item">
                    <input type="checkbox" id="filter-yellow" class="filter-checkbox" checked>
                    <div class="legend-icon yellow"></div>
                    <span>Solar Only <span id="count-yellow">(0)</span></span>
                </div>
                <div class="legend-item">
                    <input type="checkbox" id="filter-green" class="filter-checkbox" checked>
                    <div class="legend-icon green"></div>
                    <span>Solar & Battery <span id="count-green">(0)</span></span>
                </div>
                <div class="legend-item">
                    <input type="checkbox" id="filter-red" class="filter-checkbox" checked>
                    <div class="legend-icon red"></div>
                    <span>Battery Only <span id="count-red">(0)</span></span>
                </div>
                <div class="legend-item">
                    <input type="checkbox" id="filter-purple" class="filter-checkbox">
                    <div class="legend-icon purple"></div>
                    <span>HM10/15/20 <span id="count-purple">(0)</span></span>
                </div>
            `;
            
            // Add filter event listeners
            legendElement.querySelectorAll('.filter-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation(); // Prevent closing info window
                    const color = checkbox.id.replace('filter-', '');
                    toggleMarkersByType(color, checkbox.checked);
                });
            });
            
            // Prevent closing info window when clicking on legend (except checkboxes)
            legendElement.addEventListener('click', (e) => {
                if (!e.target.classList.contains('filter-checkbox')) {
                    e.stopPropagation();
                }
            });
            
            map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legendElement);

            // Close info window when clicking on stats bar or header
            document.getElementById('stats').addEventListener('click', () => {
                infoWindow.close();
            });

            // Load data from Google Sheets
            loadSheetData();
        }

        // Load data from Google Sheets
        async function loadSheetData() {
            try {
                // Check if API keys are configured
                if (CONFIG.GOOGLE_MAPS_API_KEY === 'YOUR_GOOGLE_MAPS_API_KEY_HERE' || 
                    CONFIG.GOOGLE_SHEETS_ID === 'YOUR_GOOGLE_SHEETS_ID_HERE') {
                    showError('Please update the configuration in index.html with your Google Maps API Key and Sheets ID.');
                    return;
                }

                // Fetch both sheets
                const unscheduledUrl = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.GOOGLE_SHEETS_ID}/values/${CONFIG.SHEET_NAME}?key=${CONFIG.GOOGLE_MAPS_API_KEY}`;
                const scheduledUrl = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.GOOGLE_SHEETS_ID}/values/Scheduled Jobs - Not yet Installed?key=${CONFIG.GOOGLE_MAPS_API_KEY}`;
                
                // Fetch unscheduled jobs
                const unscheduledResponse = await fetch(unscheduledUrl);
                if (!unscheduledResponse.ok) {
                    throw new Error(`Failed to fetch unscheduled data: ${unscheduledResponse.status} ${unscheduledResponse.statusText}`);
                }
                const unscheduledData = await unscheduledResponse.json();
                
                // Fetch scheduled jobs (may not exist, so handle gracefully)
                let scheduledData = null;
                try {
                    const scheduledResponse = await fetch(scheduledUrl);
                    if (scheduledResponse.ok) {
                        scheduledData = await scheduledResponse.json();
                    }
                } catch (schedError) {
                    console.log('Scheduled Jobs sheet not found or empty, continuing with unscheduled only');
                }
                
                // Process unscheduled jobs (Sheet1)
                if (unscheduledData.values && unscheduledData.values.length > 0) {
                    const unscheduledRows = unscheduledData.values.slice(1); // Skip header
                    processJobData(unscheduledRows, false, false); // isScheduled=false, skipReset=false
                }
                
                // Process scheduled jobs (Scheduled Jobs - Not yet Installed)
                if (scheduledData && scheduledData.values && scheduledData.values.length > 0) {
                    const scheduledRows = scheduledData.values.slice(1); // Skip header
                    processJobData(scheduledRows, true, true); // isScheduled=true, skipReset=true
                }
                
                if ((!unscheduledData.values || unscheduledData.values.length === 0) && 
                    (!scheduledData || !scheduledData.values || scheduledData.values.length === 0)) {
                    showError('No data found in any spreadsheet.');
                    return;
                }
                
                // Finalize map after processing all data
                finalizeMap();
                
            } catch (error) {
                console.error('Error loading sheet data:', error);
                showError(`Error loading data: ${error.message}`);
            }
        }

        // Get marker color based on system type
        function getMarkerColor(systemType) {
            if (!systemType) return 'red'; // Default to red if no system type
            
            const type = systemType.toLowerCase().trim();
            
            if (type.includes('solar only') || type === 'solar only') {
                return 'yellow';
            } else if (type.includes('solar & battery') || type.includes('solar&battery') || type.includes('solar and battery')) {
                return 'green';
            } else if (type.includes('battery only') || type === 'battery only') {
                return 'red';
            }
            
            // Default
            return 'red';
        }

        // Get marker icon URL based on color
        function getMarkerIcon(color) {
            // Use Google's chart API for colored markers
            return `http://maps.google.com/mapfiles/ms/icons/${color}-dot.png`;
        }

        // Toggle markers visibility by type
        function toggleMarkersByType(color, show) {
            markersByType[color].forEach(marker => {
                marker.setVisible(show);
            });
            
            // Close info window if currently open marker is being hidden
            if (!show) {
                infoWindow.close();
            }
        }

        // Update legend counts
        function updateLegendCounts() {
            if (!legendElement) return;
            
            const blueCount = legendElement.querySelector('#count-blue');
            const orangeCount = legendElement.querySelector('#count-orange');
            const yellowCount = legendElement.querySelector('#count-yellow');
            const greenCount = legendElement.querySelector('#count-green');
            const redCount = legendElement.querySelector('#count-red');
            const purpleCount = legendElement.querySelector('#count-purple');
            
            if (blueCount) blueCount.textContent = `(${systemTypeCounts.blue})`;
            if (orangeCount) orangeCount.textContent = `(${systemTypeCounts.orange})`;
            if (yellowCount) yellowCount.textContent = `(${systemTypeCounts.yellow})`;
            if (greenCount) greenCount.textContent = `(${systemTypeCounts.green})`;
            if (redCount) redCount.textContent = `(${systemTypeCounts.red})`;
            if (purpleCount) purpleCount.textContent = `(${systemTypeCounts.purple})`;
        }

        // Process job data and create markers
        function processJobData(rows, isScheduled = false, skipReset = false) {
            const bounds = new google.maps.LatLngBounds();
            let validCount = 0;

            // Reset counts and arrays only on first call
            if (!skipReset) {
                systemTypeCounts.blue = 0;
                systemTypeCounts.orange = 0;
                systemTypeCounts.yellow = 0;
                systemTypeCounts.green = 0;
                systemTypeCounts.red = 0;
                systemTypeCounts.purple = 0;
                markersByType.blue = [];
                markersByType.orange = [];
                markersByType.yellow = [];
                markersByType.green = [];
                markersByType.red = [];
                markersByType.purple = [];
            }

            rows.forEach((row, index) => {
                const lat = parseFloat(row[CONFIG.COLUMNS.latitude]);
                const lng = parseFloat(row[CONFIG.COLUMNS.longitude]);

                // Validate coordinates
                if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) {
                    console.warn(`Skipping row ${index + 2}: Invalid coordinates`, row);
                    return;
                }

                const position = { lat, lng };
                
                // Determine marker color based on source sheet and properties
                let markerColor;
                
                if (isScheduled) {
                    // Priority 0: Scheduled Jobs (from "Scheduled Jobs - Not yet Installed" sheet)
                    markerColor = 'blue';
                } else {
                    // For unscheduled jobs, check other properties
                    const siteInspection = row[CONFIG.COLUMNS.siteInspection] || '';
                    const systemType = row[CONFIG.COLUMNS.systemType] || '';
                    const inverterModel = row[CONFIG.COLUMNS.inverterModel] || '';
                    
                    if (siteInspection && siteInspection.toUpperCase().trim() === 'YES') {
                        // Priority 1: Site Inspection Needed
                        markerColor = 'orange';
                    } else if (inverterModel && (inverterModel.includes('HM10') || inverterModel.includes('HM15') || inverterModel.includes('HM20'))) {
                        // Priority 2: HM10/15/20 Inverters
                        markerColor = 'purple';
                    } else {
                        // Priority 3: System Type (Solar Only, Solar & Battery, Battery Only)
                        markerColor = getMarkerColor(systemType);
                    }
                }
                
                // Debug: log first few jobs
                if (index < 5) {
                    console.log(`Row ${index}: IsScheduled = ${isScheduled}, Color = ${markerColor}`);
                }
                
                // Create marker
                const marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: row[CONFIG.COLUMNS.customerName] || `Job ${index + 1}`,
                    animation: google.maps.Animation.DROP,
                    icon: getMarkerIcon(markerColor)
                });

                // Create info window content
                const content = createInfoWindowContent(row, index);

                // Add click listener
                marker.addListener('click', () => {
                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
                markersByType[markerColor].push(marker);
                systemTypeCounts[markerColor]++;
                bounds.extend(position);
                validCount++;
            });

            return { bounds, validCount };
        }

        // Finalize map after all data is loaded
        function finalizeMap() {
            // Calculate total jobs (excluding scheduled jobs in blue)
            const totalJobs = systemTypeCounts.orange + systemTypeCounts.yellow + 
                             systemTypeCounts.green + systemTypeCounts.red + systemTypeCounts.purple;
            const totalLoaded = markers.length - markersByType.blue.length;
            
            // Update stats (only unscheduled jobs)
            document.getElementById('totalJobs').textContent = totalJobs;
            document.getElementById('loadedJobs').textContent = totalLoaded;

            // Fit map to all markers
            if (markers.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                markers.forEach(marker => {
                    bounds.extend(marker.getPosition());
                });
                
                if (markers.length === 1) {
                    map.setCenter(markers[0].getPosition());
                    map.setZoom(15);
                } else {
                    map.fitBounds(bounds);
                }
            }

            // Update legend with counts
            console.log('Final counts:', systemTypeCounts);
            updateLegendCounts();

            // Hide blue and purple markers by default (checkboxes start unchecked)
            markersByType.blue.forEach(marker => {
                marker.setVisible(false);
            });
            markersByType.purple.forEach(marker => {
                marker.setVisible(false);
            });

            // Hide loading
            document.getElementById('loading').classList.add('hidden');
        }

        // Create info window HTML content
        function createInfoWindowContent(row, index) {
            const recordId = row[CONFIG.COLUMNS.recordId] || '';
            const customerName = row[CONFIG.COLUMNS.customerName] || 'Unknown Customer';
            const projectAddress = row[CONFIG.COLUMNS.projectAddress] || '';
            const systemSize = row[CONFIG.COLUMNS.systemSize] || '';
            const batterySize = row[CONFIG.COLUMNS.batterySize] || '';
            const phases = row[CONFIG.COLUMNS.phases] || '';
            const batteryLocation = row[CONFIG.COLUMNS.batteryLocation] || '';

            let html = `<div class="info-window">`;
            html += `<h3>${escapeHtml(customerName)}</h3>`;
            
            if (projectAddress) {
                html += `<div class="field">
                    <span class="label">üìç Address:</span>
                    <span class="value">${escapeHtml(projectAddress)}</span>
                </div>`;
            }
            
            if (systemSize) {
                html += `<div class="field">
                    <span class="label">‚ö° System Size:</span>
                    <span class="value">${escapeHtml(systemSize)} kW</span>
                </div>`;
            }
            
            if (batterySize) {
                html += `<div class="field">
                    <span class="label">üîã Battery Size:</span>
                    <span class="value">${escapeHtml(batterySize)} kWh</span>
                </div>`;
            }
            
            if (phases) {
                html += `<div class="field">
                    <span class="label">üîå Phases:</span>
                    <span class="value">${escapeHtml(phases)}</span>
                </div>`;
            }
            
            if (batteryLocation) {
                html += `<div class="field">
                    <span class="label">üì¶ Battery Location:</span>
                    <span class="value">${escapeHtml(batteryLocation)}</span>
                </div>`;
            }
            
            // Add HubSpot link button if record ID exists
            if (recordId) {
                const hubspotUrl = `https://app-ap1.hubspot.com/contacts/441838848/record/0-3/${recordId}`;
                html += `<div style="text-align: center; margin-top: 10px;">
                    <a href="${hubspotUrl}" target="_blank" class="hubspot-button">View in HubSpot</a>
                </div>`;
            }
            
            html += `</div>`;
            return html;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show error message
        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('errorText').textContent = message;
            document.getElementById('error').classList.remove('hidden');
        }

        // Load Google Maps API
        function loadGoogleMapsScript() {
            if (CONFIG.GOOGLE_MAPS_API_KEY === 'YOUR_GOOGLE_MAPS_API_KEY_HERE') {
                showError('Please configure your Google Maps API Key in the index.html file.');
                return;
            }

            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&callback=initMap`;
            script.async = true;
            script.defer = true;
            script.onerror = () => {
                showError('Failed to load Google Maps. Please check your API key and internet connection.');
            };
            document.head.appendChild(script);
        }

        // Start the application
        window.addEventListener('load', loadGoogleMapsScript);
    </script>
</body>
</html>

